# 母親照護系統 - 軟體設計文件 (SDD v2)

## 1. 文件資訊

| 項目 | 內容 |
|------|------|
| 版本 | 2.0 |
| 狀態 | Draft |
| 最後更新 | 2026-02-06 |
| 資料庫 | PostgreSQL |
| 主要資料表 | `z_momsystem` |

---

## 2. 專案背景與核心問題

### 2.1 問題陳述

失智症患者在就醫時存在嚴重的**資訊斷層**：

```
┌─────────────┐                              ┌─────────────┐
│   患者      │ ──(認知退化，無法自述)────>  │             │
│             │                              │    醫生     │
│   家屬      │ ──(觀察片段，記憶模糊)────>  │             │
└─────────────┘                              └──────┬──────┘
                                                    │
                                                    ▼
                                            診斷依據不足
```

**痛點：**
- 患者無法準確描述症狀發生的時間、頻率
- 家屬觀察是片段式的，無連續性
- 傳統紙本記錄難以量化與分析趨勢

### 2.2 解決方案

透過 **白板 + AI 影像辨識 + 結構化數據儲存**，建立「高粒度、可追溯」的照護記錄系統。

**資料流：**
```
白板手寫 → TAPO 攝影機 → AI 辨識 → iDempiere API → z_momsystem 表
                                                          │
                                                          ▼
                                        ┌─────────────────────────────┐
                                        │  前端 Dashboard (平板展示)  │
                                        │  - Grid 數據表格            │
                                        │  - 趨勢圖表                 │
                                        │  - AI 週報摘要              │
                                        └─────────────────────────────┘
```

---

## 3. 系統架構

### 3.1 整體架構圖

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         使用者介面層 (Frontend)                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌──────────────────┐                    ┌──────────────────┐         │
│   │   手機 (Mobile)   │                    │   平板 (Tablet)   │         │
│   │   - 日常記錄更新  │                    │   - 診間展示      │         │
│   │   - 快速輸入      │                    │   - 數據視覺化    │         │
│   └────────┬─────────┘                    └────────┬─────────┘         │
│            │                                       │                    │
│            │         Vue 3 + TypeScript + daisyUI                      │
│            │         (iDempiere-Resource-UI-main)                      │
│            └───────────────────┬───────────────────┘                    │
│                                │                                        │
└────────────────────────────────┼────────────────────────────────────────┘
                                 │ REST API
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        安全層 (Security Boundary)                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                    ┌─────────────────────────────┐                     │
│                    │    Cloudflare Zero Trust    │                     │
│                    │    - Tunnel (無開放 Port)   │                     │
│                    │    - SSO / Email OTP        │                     │
│                    └─────────────┬───────────────┘                     │
│                                  │                                      │
└──────────────────────────────────┼──────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         服務層 (Backend)                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                      iDempiere Server                           │  │
│   │                                                                 │  │
│   │   ┌─────────────────┐    ┌─────────────────────────────────┐   │  │
│   │   │   REST API      │    │   Window: Z_MomSystem           │   │  │
│   │   │  /api/v1/models │    │   - 完整文件生命週期管理        │   │  │
│   │   │  /api/v1/windows│    │   - DocAction 流程              │   │  │
│   │   └─────────────────┘    └─────────────────────────────────┘   │  │
│   │                                      │                          │  │
│   │                              ┌───────┴───────┐                  │  │
│   │                              │  PostgreSQL   │                  │  │
│   │                              │   (內部網路)  │                  │  │
│   │                              │               │                  │  │
│   │                              └───────────────┘                  │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                   ▲
                                   │ REST API (內網)
                                   │
┌─────────────────────────────────────────────────────────────────────────┐
│                         採集層 (Data Collection)                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                    Edge Processing Node (小主機)                 │  │
│   │                                                                   │  │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐ │  │
│   │   │ RTSP Client │ -> │  AI Engine  │ -> │ iDempiere API Client│ │  │
│   │   │ (定時擷取)  │    │ (白板辨識)  │    │ (UPSERT by datedoc) │ │  │
│   │   └─────────────┘    └─────────────┘    └─────────────────────┘ │  │
│   │          ▲                                                       │  │
│   └──────────┼───────────────────────────────────────────────────────┘  │
│              │ RTSP Stream                                              │
│       ┌──────┴──────┐                                                   │
│       │ TAPO 攝影機 │                                                   │
│       └─────────────┘                                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 部署模式

| 模式 | 配置 | 適用情境 |
|------|------|----------|
| **一體化** | Edge Node + iDempiere 同機 | 家庭環境、成本敏感 |
| **分離式** | Edge Node 獨立 / iDempiere 雲端 | 多據點、高可用 |

---

## 4. 資料模型

### 4.1 主表：`z_momsystem`

基於 iDempiere 標準文件架構，繼承完整的 AD 基礎欄位。

#### 4.1.1 系統欄位 (iDempiere 標準)

| 欄位 | 型別 | 說明 |
|------|------|------|
| `z_momsystem_id` | PK | 主鍵 |
| `z_momsystem_uu` | UUID | 全域唯一識別 |
| `ad_client_id` | FK | 租戶 |
| `ad_org_id` | FK | 組織 |
| `c_bpartner_id` | FK | 患者 (Business Partner) |
| `documentno` | String(30) | 文件編號 (自動產生) |
| `docstatus` | Char(2) | 文件狀態 (DR/CO/...) |
| `docaction` | Char(2) | 文件動作 |
| `processed` | Y/N | 已處理 |
| `created` / `updated` | Timestamp | 建立/更新時間 |
| `createdby` / `updatedby` | FK | 建立/更新者 |

#### 4.1.2 照護記錄欄位

| 欄位 | 型別 | 說明 | 值域範例 |
|------|------|------|----------|
| `name` | String(255) | 患者姓名 | 王小明 |
| `datedoc` | Timestamp | **記錄日期** (核心鍵) | 2026-02-05 |
| `value` | String(40) | 搜尋鍵 | - |
| `description` | String(255) | 描述 | - |

#### 4.1.3 餐食記錄

| 欄位 | 型別 | 說明 | 值域 |
|------|------|------|------|
| `breakfast` | Char(60) | 早餐 | N=正常, S=少量, A=異常 |
| `lunch` | Char(60) | 午餐 | N=正常, S=少量, A=異常 |
| `dinner` | Char(60) | 晚餐 | N=正常, S=少量, A=異常 |

#### 4.1.4 睡眠與精神狀態

| 欄位 | 型別 | 說明 | 值域 |
|------|------|------|------|
| `lastnightsleep` | Char(60) | 昨晚睡眠 | G=好, N=普通, S=差 |
| `beforesleepstatus` | Char(60) | 睡前狀態 | - |
| `morningmentalstatus` | Char(60) | 早晨精神 | N=正常, A=異常 |
| `nightactivity` | Char(60) | 夜間活動 | - |

#### 4.1.5 生理照護

| 欄位 | 型別 | 說明 |
|------|------|------|
| `excretionstatus` | Char(60) | 排泄狀況 (Reference List) |
| `bathing` | Char(60) | 洗澡 |
| `medicationissue` | Char(60) | 用藥問題 |

#### 4.1.6 生命徵象

| 欄位 | 型別 | 說明 | 範例 |
|------|------|------|------|
| `systolicbp` | Numeric | 收縮壓 (mmHg) | 129 |
| `diastolicbp` | Numeric | 舒張壓 (mmHg) | 64 |
| `pulse` | Numeric | 脈搏 (bpm) | 89 |
| `bpnote` | String(1024) | 血壓備註 | - |

#### 4.1.7 活動與安全

| 欄位 | 型別 | 說明 |
|------|------|------|
| `dailyactivity` | Char(60) | 日常活動 |
| `outgoing` | Char(50) | 外出記錄 |
| `companionship` | Char(60) | 陪伴狀況 |
| `safetyincident` | String(4096) | 安全事件 (長文) |

#### 4.1.8 其他

| 欄位 | 型別 | 說明 |
|------|------|------|
| `text` | String(510) | 自由文字 |
| `help` | String(2000) | 補充說明 |

### 4.2 資料範例

```
┌────────┬────────────┬─────────────────────┬───────────┬───────┬────────┬────────────────┬────────────┬─────────────┬───────┐
│  name  │ documentno │       datedoc       │ breakfast │ lunch │ dinner │ lastnightsleep │ systolicbp │ diastolicbp │ pulse │
├────────┼────────────┼─────────────────────┼───────────┼───────┼────────┼────────────────┼────────────┼─────────────┼───────┤
│ 王小明 │ 0000001    │ 2026-01-05 00:00:00 │ N         │ N     │ N      │ G              │        125 │          80 │    72 │
│ 王小明 │ 0000002    │ 2026-01-04 00:00:00 │ N         │ N     │ N      │ S              │            │             │       │
│ 王小明 │ 0000003    │ 2026-01-03 00:00:00 │ N         │ N     │ N      │ G              │            │             │       │
│ 王小明 │ 0000004    │ 2026-01-02 00:00:00 │ N         │ N     │ N      │ G              │        118 │          75 │    68 │
│ 王小明 │ 0000005    │ 2026-01-01 00:00:00 │ N         │ N     │ N      │                │            │             │       │
└────────┴────────────┴─────────────────────┴───────────┴───────┴────────┴────────────────┴────────────┴─────────────┴───────┘
```

### 4.3 資料同步策略

採用 **UPSERT by datedoc + c_bpartner_id**：

```
同一天的記錄只有一筆，後續更新覆蓋既有資料
```

---

## 5. 前端技術架構

### 5.1 技術棧

| 項目 | 技術 |
|------|------|
| Framework | Vue 3 (Composition API + `<script setup>`) |
| Language | TypeScript |
| Build | Vite (base: `/emui/`) |
| UI Library | daisyUI (Tailwind CSS) |
| HTTP Client | ky (封裝於 `apiFetch`) |
| State | Composables + localStorage |

### 5.2 專案結構

```
iDempiere-Resource-UI-main/
├── ui/
│   ├── src/
│   │   ├── app/views/           # 頁面元件
│   │   │   ├── LoginPage.vue    # 登入
│   │   │   ├── BookingPage.vue  # 預約 (已完成)
│   │   │   └── MomSystemPage.vue # 照護記錄 (待開發)
│   │   ├── features/
│   │   │   ├── auth/            # 認證模組
│   │   │   ├── momsystem/       # 照護記錄模組 (待開發)
│   │   │   │   ├── api.ts       # API 呼叫
│   │   │   │   └── types.ts     # TypeScript 型別
│   │   │   └── ...
│   │   └── shared/
│   │       └── api/http.ts      # apiFetch 封裝
│   └── vite.config.ts
└── src/                          # Java Servlet (SPA hosting)
```

### 5.3 API 呼叫模式

```typescript
import { apiFetch } from '../../shared/api/http'

// 列表查詢
const res = await apiFetch<{ records: MomSystemRecord[] }>(
  `/api/v1/models/Z_MomSystem`,
  {
    token,
    searchParams: {
      $filter: `C_BPartner_ID eq ${bpartnerId}`,
      $orderby: 'DateDoc desc',
      $top: 30
    }
  }
)

// 新增記錄 (透過 Window 觸發商業邏輯)
await apiFetch(`/api/v1/windows/mom-system`, {
  method: 'POST',
  token,
  json: {
    DateDoc: '2026-02-06',
    C_BPartner_ID: bpartnerId,
    Breakfast: 'N',
    Lunch: 'N',
    // ...
  }
})

// 更新記錄
await apiFetch(`/api/v1/models/Z_MomSystem/${id}`, {
  method: 'PUT',
  token,
  json: { SystolicBP: 125, DiastolicBP: 80, Pulse: 72 }
})
```

### 5.4 裝置適配策略

```
┌─────────────────────────────────────────────────────────────────┐
│                      響應式介面設計                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   手機 (< 768px)                平板 (>= 768px)                │
│   ┌───────────────┐             ┌─────────────────────────┐    │
│   │  ┌─────────┐  │             │  ┌─────────┬─────────┐  │    │
│   │  │今日記錄 │  │             │  │  Grid   │  Chart  │  │    │
│   │  │快速輸入 │  │             │  │  數據   │  趨勢   │  │    │
│   │  └─────────┘  │             │  │  表格   │  圖表   │  │    │
│   │  ┌─────────┐  │             │  └─────────┴─────────┘  │    │
│   │  │血壓輸入 │  │             │  ┌─────────────────────┐│    │
│   │  └─────────┘  │             │  │    AI 週報摘要      ││    │
│   │  ┌─────────┐  │             │  └─────────────────────┘│    │
│   │  │狀態速選 │  │             └─────────────────────────┘    │
│   │  └─────────┘  │                                            │
│   └───────────────┘             主要用途：                      │
│                                 - 診間展示給醫生                │
│   主要用途：                    - 趨勢分析                      │
│   - 照顧者日常記錄              - 完整數據檢視                  │
│   - 即時更新                                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 安全架構

### 6.1 Zero Trust 存取流程

```
使用者              Cloudflare              iDempiere
   │                    │                       │
   │  1. 存取請求       │                       │
   │ ─────────────────> │                       │
   │                    │                       │
   │  2. 身分驗證       │                       │
   │ <───────────────── │                       │
   │    (Email OTP)     │                       │
   │                    │                       │
   │  3. OTP 驗證       │                       │
   │ ─────────────────> │                       │
   │                    │                       │
   │                    │  4. Tunnel 轉發       │
   │                    │ ────────────────────> │
   │                    │                       │
   │                    │  5. iDempiere 登入    │
   │ <──────────────────────────────────────────│
   │                    │     (Token)           │
   │                    │                       │
   │  6. API 請求 (Bearer Token)                │
   │ ─────────────────────────────────────────> │
   │                    │                       │
```

### 6.2 安全控制層級

| 層級 | 控制措施 |
|------|----------|
| **網路** | Cloudflare Tunnel - 無對外 Port |
| **身分** | SSO / Email OTP (Cloudflare Access) |
| **應用** | iDempiere Token + RBAC |
| **傳輸** | TLS 1.3 全程加密 |
| **備援** | Tailscale (備用 VPN) |

### 6.3 隱私保護

- 資料儲存於自有主機，不上傳第三方
- AI 分析時使用去識別化資料
- 影像不儲存，僅保留辨識後的結構化結果

---

## 7. 使用流程

### 7.1 日常照護記錄

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           每日照護流程                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   07:30        12:00         18:00         20:00         20:30         │
│     │            │             │             │             │            │
│     ▼            ▼             ▼             ▼             ▼            │
│  ┌──────┐    ┌──────┐     ┌──────┐     ┌──────┐     ┌──────┐          │
│  │晨間  │    │午餐  │     │晚餐  │     │量血壓│     │睡前  │          │
│  │精神  │    │記錄  │     │記錄  │     │記錄  │     │狀態  │          │
│  │評估  │    │      │     │      │     │      │     │      │          │
│  └──┬───┘    └──┬───┘     └──┬───┘     └──┬───┘     └──┬───┘          │
│     │           │            │            │            │               │
│     └───────────┴────────────┴────────────┴────────────┘               │
│                              │                                          │
│                              ▼                                          │
│                    ┌─────────────────┐                                 │
│                    │    白板記錄     │                                 │
│                    └────────┬────────┘                                 │
│                              │                                          │
│              ┌───────────────┼───────────────┐                         │
│              │               │               │                          │
│              ▼               ▼               ▼                          │
│      ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                  │
│      │ AI 自動辨識 │ │ 手機補充    │ │ 異常修正    │                  │
│      │ (定時擷取)  │ │ (家屬)      │ │ (家屬)      │                  │
│      └──────┬──────┘ └──────┬──────┘ └──────┬──────┘                  │
│             │               │               │                          │
│             └───────────────┴───────────────┘                          │
│                             │                                           │
│                             ▼                                           │
│                    ┌─────────────────┐                                 │
│                    │   z_momsystem   │                                 │
│                    │   (當日記錄)    │                                 │
│                    └─────────────────┘                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 7.2 診間展示流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           診間展示情境                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  家屬操作：                                                             │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │ 1. 打開平板 → 輸入網址 → Cloudflare OTP 驗證 → iDempiere 登入 │    │
│  │ 2. 選擇患者 → 選擇日期範圍 (預設: 近 30 天)                   │    │
│  │ 3. 展示 Dashboard 給醫生                                      │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  Dashboard 畫面：                                                       │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  ┌─────────────────────────────────────────────────────────┐   │    │
│  │  │                    患者：王小明                          │   │    │
│  │  │                    期間：2026/01/01 ~ 2026/01/31         │   │    │
│  │  └─────────────────────────────────────────────────────────┘   │    │
│  │                                                                │    │
│  │  ┌──────────────────────┬──────────────────────────────────┐  │    │
│  │  │     AI 週報摘要      │         血壓趨勢圖               │  │    │
│  │  │                      │                                  │  │    │
│  │  │  過去一週整體狀況    │     140┤    ╭─╮                 │  │    │
│  │  │  穩定，睡眠品質較    │        │   ╱  ╲    ╭╮          │  │    │
│  │  │  上週改善。血壓維    │     120┤──╯    ╲──╯ ╲─        │  │    │
│  │  │  持正常範圍，建議    │        │                         │  │    │
│  │  │  持續觀察...         │      80┤  ─────────────────      │  │    │
│  │  │                      │        └─────────────────────    │  │    │
│  │  │                      │          01  02  03  04  05      │  │    │
│  │  └──────────────────────┴──────────────────────────────────┘  │    │
│  │                                                                │    │
│  │  ┌─────────────────────────────────────────────────────────┐  │    │
│  │  │                    詳細記錄表格                          │  │    │
│  │  │  日期    │ 早餐 │ 午餐 │ 晚餐 │ 睡眠 │ 血壓      │ 備註 │  │    │
│  │  │  01/05   │ 正常 │ 正常 │ 正常 │ 好   │ 125/80    │      │  │    │
│  │  │  01/04   │ 正常 │ 正常 │ 正常 │ 差   │ -         │      │  │    │
│  │  │  01/03   │ 正常 │ 正常 │ 正常 │ 好   │ -         │      │  │    │
│  │  │  01/02   │ 正常 │ 正常 │ 正常 │ 好   │ 118/75    │      │  │    │
│  │  └─────────────────────────────────────────────────────────┘  │    │
│  │                                                                │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 8. AI 分析模組

### 8.1 功能設計

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│ z_momsystem │ ───> │   Prompt    │ ───> │ Gemini API  │
│  (7天資料)  │      │ Engineering │      │             │
└─────────────┘      └─────────────┘      └──────┬──────┘
                                                  │
                                                  ▼
                                         ┌─────────────────┐
                                         │    照護週報     │
                                         │  ─────────────  │
                                         │  • 整體評估     │
                                         │  • 異常提醒     │
                                         │  • 趨勢分析     │
                                         │  • 建議事項     │
                                         └─────────────────┘
```

### 8.2 Prompt 設計

```
你是專業的長照護理師助手。

輸入資料：過去 7 天的照護記錄 (JSON)

請提供：
1. 整體狀態評估 (2-3 句話，給家屬看)
2. 值得注意的變化或異常
3. 建議醫生關注的重點
4. 趨勢分析 (睡眠、飲食、血壓)

注意：
- 不做醫療診斷
- 標註資料不足的部分
- 使用淺顯易懂的語言
```

---

## 9. 開發與維運

### 9.1 開發環境

```bash
# 前端開發
cd iDempiere-Resource-UI-main/ui
bun run dev    # http://localhost:5173/emui/

# 資料庫連線 (請參考 .env 設定)
psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d idempiere
```

### 9.2 監控項目

| 項目 | 方式 | 告警條件 |
|------|------|----------|
| Cloudflare Tunnel | Dashboard | 連線中斷 > 5 分鐘 |
| iDempiere API | Health Check | 回應 > 30 秒 |
| PostgreSQL | pg_stat | 連線數 > 80% |
| AI 擷取 Cron | Log | 連續失敗 > 3 次 |

### 9.3 備份策略

```
每日 02:00
    │
    ▼
pg_dump → /backup/daily/ (保留 7 天)
              │
              ▼
         異地備份 (選配，保留 30 天)
```

---


## 附錄

### A. 值域對照表

| 欄位 | 值 | 說明 |
|------|-----|------|
| `breakfast/lunch/dinner` | N | 正常 |
| | S | 少量 |
| | A | 異常 |
| `lastnightsleep` | G | 好 (Good) |
| | N | 普通 (Normal) |
| | S | 差 (Sleep poorly) |
| `morningmentalstatus` | N | 正常 |
| | A | 異常 |

### B. API 端點清單

```
GET    /api/v1/models/Z_MomSystem              # 列表
GET    /api/v1/models/Z_MomSystem/{id}         # 單筆
POST   /api/v1/windows/mom-system              # 新增 (含商業邏輯)
PUT    /api/v1/models/Z_MomSystem/{id}         # 更新
DELETE /api/v1/models/Z_MomSystem/{id}         # 刪除
```

### C. 參考資料

- [iDempiere REST API Wiki](https://wiki.idempiere.org/en/REST_Web_Services)
- [Cloudflare Zero Trust Docs](https://developers.cloudflare.com/cloudflare-one/)
- [Vue 3 Composition API](https://vuejs.org/guide/extras/composition-api-faq.html)
- [daisyUI Components](https://daisyui.com/components/)
