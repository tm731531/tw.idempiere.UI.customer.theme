<script setup lang="ts">
import { computed, onMounted, ref, watch } from 'vue'
import ErrorMessage from '../../components/ErrorMessage.vue'
import { useAuth } from '../../features/auth/store'
import { listMomData, type MomData, getLatestMomRecordId, uploadMomAttachment, createMomData, updateMomData, generateGeminiContent, getGeminiApiKey, fetchMomColumnMetadata, type MomPayload } from '../../features/mom/api'
import { toPng } from 'html-to-image'
import jsPDF from 'jspdf'

const auth = useAuth()

const loading = ref(false)
const exporting = ref(false)
const error = ref<string | null>(null)
const successMessage = ref<string | null>(null)
const records = ref<MomData[]>([])
const reportArea = ref<HTMLElement | null>(null)
const showModal = ref(false)
const modalMode = ref<'create' | 'edit' | 'ai'>('create')
const editingId = ref<number | null>(null)
const aiGenerating = ref(false)
const aiResult = ref('')
const form = ref({
    documentDate: new Date().toISOString().split('T')[0],
    name: 'Mom',
    description: '',
    nightActivity: '無',
    beforeSleepStatus: '正常',
    lastNightSleep: '正常',
    morningMentalStatus: '正常',
    breakfast: '正常',
    dailyActivity: '正常',
    lunch: '正常',
    outgoing: '無',
    dinner: '正常',
    companionship: '無',
    excretionStatus: '正常',
    bathing: '正常',
    safetyIncident: '無'
})

// Initial empty options, will be populated from metadata
const options = ref<Record<string, { value: string, label: string }[]>>({})
const fieldLabels = ref<Record<string, string>>({})
const fieldDefaults = ref<Record<string, string>>({})

// Fallback list if key not found (formatted as objects)
const defaultStatusList = [
    { value: '', label: '' },
    { value: '正常', label: '正常' },
    { value: '異常', label: '異常' },
    { value: '無', label: '無' }
] // Fallback: assuming value=label if not found from metadata

// Helper to get label to display in Table/Chart
function getLabel(key: string, value?: string) {
    if (!value) return '—'
    
    // Camel case key
    const camelKey = key.charAt(0).toLowerCase() + key.slice(1)
    
    // Find list
    const list = options.value[camelKey]
    if (list) {
        const item = list.find(x => x.value === value)
        if (item) return item.label
    }
    
    // If not found in list, return value itself (maybe it was legacy data or not in list)
    return value
}

// Filters
const dateFrom = ref(new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0])
const dateTo = ref(new Date().toISOString().split('T')[0])

// Chart Metric Selection
const chartMetric = ref<keyof MomData>('morningMentalStatus')
const availableMetrics = computed(() => [
  { label: fieldLabels.value['morningMentalStatus'] || '起床精神', value: 'morningMentalStatus' },
  { label: fieldLabels.value['lastNightSleep'] || '昨夜睡眠', value: 'lastNightSleep' },
  { label: fieldLabels.value['beforeSleepStatus'] || '睡前狀況', value: 'beforeSleepStatus' },
  { label: fieldLabels.value['breakfast'] || '早餐', value: 'breakfast' },
  { label: fieldLabels.value['lunch'] || '午餐', value: 'lunch' },
  { label: fieldLabels.value['dinner'] || '晚餐', value: 'dinner' },
  { label: fieldLabels.value['dailyActivity'] || '活動', value: 'dailyActivity' },
  { label: fieldLabels.value['excretionStatus'] || '排泄狀況', value: 'excretionStatus' },
  { label: fieldLabels.value['bathing'] || '洗澡', value: 'bathing' },
])

// Pie Chart Statistics
const stats = computed(() => {
  const map = new Map<string, number>()
  const metricKey = chartMetric.value
  for (const r of records.value) {
    const val = r[metricKey]
    if (val && typeof val === 'string') {
      // Use Label for Chart Grouping
      const label = getLabel(metricKey, val)
      map.set(label, (map.get(label) || 0) + 1)
    }
  }
  return Array.from(map.entries()).map(([label, count]) => ({ label, count }))
})

// Pie Chart Calculations
const pieSlices = computed(() => {
  const total = stats.value.reduce((sum, s) => sum + s.count, 0)
// ... logic continues ...
  if (total === 0) return []
  let currentAngle = 0
  
  const getColor = (label: string, index: number) => {
    // Colors based on Label content
    const positive = ['正常', '穩定', '完成', '良好', '優良', '有精神']
    const neutral = ['一般', '尚可', '未完成', '無']
    const negative = ['亢奮', '疲憊', '差', '極差', '異常', '失禁', '出血', '跌倒', '嗜睡', '焦慮']
    
    if (positive.includes(label)) return '#10b981'
    if (negative.includes(label)) return '#f43f5e'
    if (neutral.includes(label)) return '#f59e0b'
    
    const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#64748b']
    return colors[index % colors.length]
  }

  return stats.value.map((s, i) => {
    const angle = (s.count / total) * 360
    const startAngle = currentAngle
    currentAngle += angle
    if (angle >= 359.9) return { label: s.label, count: s.count, isFull: true, color: getColor(s.label, i), percent: 100 }
    const x1 = 50 + 40 * Math.cos((startAngle - 90) * Math.PI / 180)
    const y1 = 50 + 40 * Math.sin((startAngle - 90) * Math.PI / 180)
    const x2 = 50 + 40 * Math.cos((currentAngle - 90) * Math.PI / 180)
    const y2 = 50 + 40 * Math.sin((currentAngle - 90) * Math.PI / 180)
    const largeArcFlag = angle > 180 ? 1 : 0
    return {
      label: s.label,
      count: s.count,
      isFull: false,
      path: `M 50 50 L ${x1} ${y1} A 40 40 0 ${largeArcFlag} 1 ${x2} ${y2} Z`,
      color: getColor(s.label, i),
      percent: Math.round((s.count / total) * 100)
    }
  })
})

async function loadData() {
  if (!auth.token.value) return
  loading.value = true
  error.value = null
  try {
    const [res, meta] = await Promise.all([
        listMomData(auth.token.value, { dateFrom: dateFrom.value, dateTo: dateTo.value }),
        fetchMomColumnMetadata(auth.token.value)
    ])
    records.value = res.records
    
    // Merge fetched metadata into options
    for (const [key, list] of Object.entries(meta.options)) {
        const camelKey = key.charAt(0).toLowerCase() + key.slice(1)
        // Prepend a blank option to every list as per user request
        options.value[camelKey] = [{ value: '', label: '' }, ...list]
    }
    // Store field labels and defaults
    for (const [key, label] of Object.entries(meta.labels)) {
        const camelKey = key.charAt(0).toLowerCase() + key.slice(1)
        fieldLabels.value[camelKey] = label;
    }
    // Map Defaults (Label -> Value)
    // The DB default (from AD_Column/AD_Field) might be a Value (e.g. 'Y') or a Label/Name (e.g. '完成') depending on configuration.
    // Our "Standard Day" fallback uses Labels (e.g. '完成').
    // We need to store the VALUE in fieldDefaults.
    const findValueForDefault = (key: string, def: string) => {
        const camelKey = key.charAt(0).toLowerCase() + key.slice(1)
        const list = options.value[camelKey]
        if (!list) return def // No list, assume text
        
        // Try to find by Value first
        const byVal = list.find(x => x.value === def)
        if (byVal) return def
        
        // Try to find by Label
        const byLabel = list.find(x => x.label === def)
        if (byLabel) return byLabel.value
        
        return def // Fallback
    }

    for (const [key, def] of Object.entries(meta.defaults)) {
        const camelKey = key.charAt(0).toLowerCase() + key.slice(1)
        fieldDefaults.value[camelKey] = findValueForDefault(key, def);
    }
    
  } catch (e: any) {
    error.value = e?.detail || e?.message || '載入失敗'
  } finally {
    loading.value = false
  }
}

function openCreateModal() {
    modalMode.value = 'create'
    editingId.value = null
    const today = new Date().toISOString().split('T')[0]
    
    // Helper to resolve fallback (which users provided as Labels) to Values
    const resolve = (key: string, fallbackLabel: string) => {
        const val = fieldDefaults.value[key]
        if (val) return val // Database default (already resolved to value)
        
        // Fallback Label -> Value
        const list = options.value[key]
        if (list) {
            const item = list.find(x => x.label === fallbackLabel)
            if (item) return item.value
        }
        return fallbackLabel
    }

    // Apply defaults from metadata if available, otherwise fallback to "Standard Day" (Screenshot values)
    form.value = {
        documentDate: fieldDefaults.value.documentDate || today,
        name: fieldDefaults.value.name || '孫玉美',
        description: fieldDefaults.value.description || '',
        nightActivity: resolve('nightActivity', '完成'),
        beforeSleepStatus: resolve('beforeSleepStatus', '正常'),
        lastNightSleep: resolve('lastNightSleep', '良好'),
        morningMentalStatus: resolve('morningMentalStatus', '穩定'),
        breakfast: resolve('breakfast', '正常'),
        dailyActivity: resolve('dailyActivity', '完成'),
        lunch: resolve('lunch', '正常'),
        outgoing: resolve('outgoing', '完成'),
        dinner: resolve('dinner', '正常'),
        companionship: resolve('companionship', '穩定'),
        excretionStatus: resolve('excretionStatus', '正常'),
        bathing: resolve('bathing', '完成'),
        safetyIncident: resolve('safetyIncident', '無')
    }
    showModal.value = true
}

function openEditModal(row: MomData) {
    modalMode.value = 'edit'
    editingId.value = row.id
    form.value = {
        documentDate: row.documentDate ? row.documentDate.split(' ')[0] : '',
        name: row.name,
        description: row.description || '',
        nightActivity: row.nightActivity || '無',
        beforeSleepStatus: row.beforeSleepStatus || '正常',
        lastNightSleep: row.lastNightSleep || '正常',
        morningMentalStatus: row.morningMentalStatus || '正常',
        breakfast: row.breakfast || '正常',
        dailyActivity: row.dailyActivity || '正常',
        lunch: row.lunch || '正常',
        outgoing: row.outgoing || '無',
        dinner: row.dinner || '正常',
        companionship: row.companionship || '無',
        excretionStatus: row.excretionStatus || '正常',
        bathing: row.bathing || '正常',
        safetyIncident: row.safetyIncident || '無'
    }
    showModal.value = true
}

function openAiModal() {
    modalMode.value = 'ai'
    aiResult.value = ''
    showModal.value = true
}

async function handleSave() {
    if (!auth.token.value) return
    loading.value = true
    try {
        // Helper to convert empty string to undefined (or null) to avoid Backend Validation Validation Error (500)
        // iDempiere Reference Lists often treat "" as an invalid value, whereas null/undefined is accepted as "empty".
        const sanitize = (val: string | undefined) => (val === '' ? undefined : val)

        const payload: MomPayload = {
            DateDoc: form.value.documentDate,
            Name: form.value.name,
            Description: form.value.description,
            NightActivity: sanitize(form.value.nightActivity),
            BeforeSleepStatus: sanitize(form.value.beforeSleepStatus),
            LastNightSleep: sanitize(form.value.lastNightSleep),
            MorningMentalStatus: sanitize(form.value.morningMentalStatus),
            Breakfast: sanitize(form.value.breakfast),
            DailyActivity: sanitize(form.value.dailyActivity),
            Lunch: sanitize(form.value.lunch),
            outgoing: sanitize(form.value.outgoing),
            Dinner: sanitize(form.value.dinner),
            Companionship: sanitize(form.value.companionship),
            ExcretionStatus: sanitize(form.value.excretionStatus),
            Bathing: sanitize(form.value.bathing),
            SafetyIncident: sanitize(form.value.safetyIncident)
        }

        if (modalMode.value === 'create') {
            await createMomData(auth.token.value, payload)
            successMessage.value = '新增成功'
        } else {
            if (editingId.value) {
                await updateMomData(auth.token.value, editingId.value, payload)
                successMessage.value = '更新成功'
            }
        }
        showModal.value = false
        setTimeout(() => successMessage.value = null, 3000)
        loadData()
    } catch (e: any) {
        error.value = e.message || '儲存失敗'
    } finally {
        loading.value = false
    }
}

async function handleAiGenerate() {
    if (!auth.token.value) return
    aiGenerating.value = true
    error.value = null
    try {
        // 1. Fetch API Key from backend config
        const apiKey = await getGeminiApiKey(auth.token.value)
        if (!apiKey) {
           throw new Error('未設定 API Key。請在 iDempiere System Config 設定 GEMINI_API_KEY。')
        }

        // 2. Prepare prompt from records
        const dataText = records.value.map(r => 
            `日期: ${r.documentDate}, 名稱: ${r.name}, 
             ${fieldLabels.value['morningMentalStatus'] || '起床精神'}: ${getLabel('morningMentalStatus', r.morningMentalStatus)}, 
             ${fieldLabels.value['lastNightSleep'] || '昨夜睡眠'}: ${getLabel('lastNightSleep', r.lastNightSleep)}, 
             備註/Memo: ${r.description || '無'}`
        ).join('\n')
        
        const prompt = `請根據以下健康紀錄資料，進行一份簡短的健康狀況統整摘要 (Memo跟日期整理):\n\n${dataText}`
        
        // 3. Call Gemini
        const result = await generateGeminiContent(apiKey, prompt)
        aiResult.value = result
    } catch (e: any) {
        error.value = 'AI 生成失敗: ' + (e.message || '未知錯誤')
    } finally {
        aiGenerating.value = false
    }
}

async function exportAndAttach() {
  if (!auth.token.value || !reportArea.value || exporting.value) return
  
  exporting.value = true
  error.value = null
  successMessage.value = null

  try {
    // 1. Get Latest iDempiere Record
    const latestId = await getLatestMomRecordId(auth.token.value)
    if (!latestId) throw new Error('找不到最新的紀錄，請確認資料庫已有資料')

    // 2. Capture DOM to Image (Using html-to-image to bypass html2canvas oklch bug)
    const dataUrl = await toPng(reportArea.value, {
      backgroundColor: '#ffffff',
      cacheBust: true,
      // Filter out UI elements that should not be in the PDF
      filter: (node) => {
        const exclusionClasses = ['no-export', 'data-html2canvas-ignore']
        const el = node as HTMLElement
        if (el.classList) {
          return !exclusionClasses.some(cls => el.classList.contains(cls))
        }
        return true
      }
    })

    // 3. Create PDF with jsPDF
    const pdf = new jsPDF({
      orientation: 'landscape',
      unit: 'mm',
      format: 'a4'
    })

    const imgProps = pdf.getImageProperties(dataUrl)
    const pdfWidth = pdf.internal.pageSize.getWidth()
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width
    
    // If table is long, it might overflow. For now we scale to width.
    // In landscape A4, width is 297mm.
    pdf.addImage(dataUrl, 'PNG', 0, 0, pdfWidth, Math.min(pdfHeight, 210))

    const pdfBlob = pdf.output('blob')
    const now = new Date()
    const timestamp = now.toISOString().replace(/[:T-]/g, '').slice(0, 14)
    const filename = `${timestamp}_MomReport.pdf`

    // 4. Upload Attachment
    await uploadMomAttachment(auth.token.value, latestId, pdfBlob, filename)

    successMessage.value = `報表已成功掛載至紀錄 (#${latestId})！`
    setTimeout(() => { successMessage.value = null }, 5000)

  } catch (e: any) {
    console.error('EXPORT CRASH:', e)
    error.value = `導出失敗: ${e?.message || '連線逾時或編碼異常'}`
  } finally {
    exporting.value = false
  }
}

function formatDate(dateStr: string) { return dateStr ? dateStr.split(' ')[0] : '' }

function getStatusBadgeStyle(label?: string) {
  if (!label) return { backgroundColor: '#f1f5f9', color: '#94a3b8' }
  const positive = ['正常', '穩定', '完成', '良好', '優良']
  const neutral = ['一般', '尚可', '未完成']
  const negative = ['亢奮', '疲憊', '差', '極差', '異常', '失禁', '出血', '跌倒']
  if (positive.includes(label)) return { backgroundColor: '#dcfce7', color: '#166534' }
  if (negative.includes(label)) return { backgroundColor: '#fee2e2', color: '#991b1b' }
  if (neutral.includes(label)) return { backgroundColor: '#fef3c7', color: '#92400e' }
  return { backgroundColor: '#dbeafe', color: '#1e40af' }
}

onMounted(() => loadData())
watch([dateFrom, dateTo], () => loadData())
</script>

<template>
  <div class="space-y-6">
    <!-- UI Controls -->
    <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm no-export">
      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          <h1 class="text-lg font-bold" style="color: #1e293b;">Mom 報表數據中心</h1>
          <p class="mt-1 text-sm text-slate-500">視覺化統計與 PDF 存檔工具</p>
        </div>
        <div class="flex items-center gap-3">
          <input v-model="dateFrom" type="date" class="rounded-lg border border-slate-300 px-3 py-2 text-sm" />
          <span class="text-slate-400">至</span>
          <input v-model="dateTo" type="date" class="rounded-lg border border-slate-300 px-3 py-2 text-sm" />
          <button 
                @click="openAiModal"
                class="rounded-lg bg-purple-600 px-4 py-2 text-sm font-bold text-white shadow hover:bg-purple-700 transition-all active:scale-95 flex items-center gap-2"
                style="background-color: #9333ea;"
            >
                ✨ AI 統整
            </button>
            <button 
                @click="openCreateModal"
                class="rounded-lg bg-emerald-600 px-4 py-2 text-sm font-bold text-white shadow hover:bg-emerald-700 transition-all active:scale-95 flex items-center gap-2"
                style="background-color: #059669;"
            >
                ➕ 新增
            </button>
          <button 
            @click="exportAndAttach" 
            :disabled="exporting || records.length === 0"
            class="rounded-lg bg-blue-600 px-6 py-2 text-sm font-bold text-white shadow-lg hover:bg-blue-700 disabled:opacity-50 transition-all active:scale-95"
            style="background-color: #2563eb;"
          >
            <span v-if="exporting" class="animate-spin mr-2 h-4 w-4 border-2 border-white border-t-transparent inline-block rounded-full"></span>
            {{ exporting ? '處理中...' : '產出 PDF 並掛載' }}
          </button>
        </div>
      </div>
    </div>

    <!-- UI Overlay / Notifications -->
    <div class="no-export">
      <ErrorMessage :message="error" />
      <div v-if="successMessage" class="rounded-xl p-4 text-sm font-bold text-green-700 border border-green-200" style="background-color: #f0fdf4;">
        ✅ {{ successMessage }}
      </div>
    </div>

    <!-- The Report Area (Captured as Image -> PDF) -->
    <div ref="reportArea" style="background: #ffffff; padding: 30px; border: 1px solid #f1f5f9; border-radius: 12px; font-family: sans-serif;">
      
      <!-- PDF Only Title -->
      <div class="hidden print-only" style="display: block; text-align: center; margin-bottom: 30px; border-bottom: 2px solid #334155; padding-bottom: 20px;">
        <h1 style="font-size: 28px; margin: 0; font-weight: 900; color: #0f172a;">Mom 每每日健康維護統計報告</h1>
        <div style="font-size: 13px; color: #64748b; margin-top: 8px; font-weight: 600;">
          查詢週期：{{ dateFrom }} ~ {{ dateTo }} | 產生時間：{{ new Date().toLocaleString() }}
        </div>
      </div>

      <!-- Stats Grid -->
      <div style="display: flex; gap: 20px; margin-bottom: 30px">
        <!-- Pie -->
        <div style="flex: 2; border: 1px solid #e2e8f0; border-radius: 12px; padding: 25px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h3 style="margin: 0; color: #1e293b; font-size: 18px; font-weight: 800;">{{ availableMetrics.find(m => m.value === chartMetric)?.label }}分佈統計</h3>
            <select v-model="chartMetric" class="no-export" style="border: 1px solid #e2e8f0; border-radius: 4px; padding: 4px 10px;">
              <option v-for="m in availableMetrics" :key="m.value" :value="m.value">{{ m.label }}</option>
            </select>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-around;" v-if="pieSlices.length > 0">
            <div style="width: 180px; height: 180px;">
              <svg viewBox="0 0 100 100" style="transform: rotate(-90deg);">
                <template v-for="(slice, i) in pieSlices" :key="i">
                  <circle v-if="slice.isFull" cx="50" cy="50" r="40" :fill="slice.color" />
                  <path v-else :d="slice.path" :fill="slice.color" />
                </template>
              </svg>
            </div>
            <div style="display: grid; gap: 8px;">
              <div v-for="slice in pieSlices" :key="slice.label" style="display: flex; align-items: center; gap: 12px;">
                <div :style="{ width: '12px', height: '12px', borderRadius: '3px', backgroundColor: slice.color }"></div>
                <span style="font-weight: 700; color: #334155; font-size: 14px;">{{ slice.label }}</span>
                <span style="color: #94a3b8; font-size: 14px;">{{ slice.count }} 筆 ({{ slice.percent }}%)</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Summary -->
        <div style="flex: 1; border: 1px solid #e2e8f0; border-radius: 12px; padding: 25px; background: #fcfcfc;">
          <h3 style="margin: 0 0 20px 0; color: #1e293b; font-size: 18px; font-weight: 800;">數據總結</h3>
          <div style="padding: 15px; background: #ffffff; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 13px; color: #64748b; font-weight: 800;">紀錄總天數</span>
            <span style="font-size: 32px; font-weight: 900; color: #2563eb;">{{ records.length }}</span>
          </div>
          <div style="padding: 15px; background: #eff6ff; border-radius: 12px; border: 1px solid #dbeafe;">
            <div style="font-size: 11px; color: #1d4ed8; font-weight: 900; margin-bottom: 10px;">強勢指標</div>
            <div style="display: grid; gap: 6px;">
              <div v-for="slice in pieSlices.slice(0, 3)" :key="slice.label" style="display: flex; justify-content: space-between; font-size: 13px;">
                <span style="font-weight: 800; color: #1e40af;">{{ slice.label }}</span>
                <span style="font-weight: 900; color: #1d4ed8;">{{ slice.percent }}%</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Table Section -->
      <div style="border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden;">
        <div style="padding: 15px 25px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
          <h3 style="margin: 0; color: #1e293b; font-size: 16px; font-weight: 800;">每日健康明細清單</h3>
        </div>
        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
          <thead>
            <tr>
              <th style="padding: 12px 10px; color: #94a3b8; border-bottom: 2px solid #e2e8f0; text-align: left;">日期</th>
              <th style="padding: 12px 10px; color: #94a3b8; border-bottom: 2px solid #e2e8f0; text-align: left;">姓名</th>
              <th style="padding: 12px 10px; color: #94a3b8; border-bottom: 2px solid #e2e8f0; text-align: center;">核心狀態</th>
              <th style="padding: 12px 10px; color: #94a3b8; border-bottom: 2px solid #e2e8f0; text-align: center;">三餐紀錄</th>
              <th style="padding: 12px 10px; color: #94a3b8; border-bottom: 2px solid #e2e8f0; text-align: center;">生理/活動</th>
              <th style="padding: 12px 10px; color: #94a3b8; border-bottom: 2px solid #e2e8f0; text-align: left;">備註</th>
              <th style="padding: 12px 10px; color: #94a3b8; border-bottom: 2px solid #e2e8f0; text-align: right;" class="no-export">操作</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="row in records" :key="row.id" style="border-bottom: 1px solid #f1f5f9;">
              <td style="padding: 12px 10px; color: #64748b; white-space: nowrap">{{ formatDate(row.documentDate) }}</td>
              <td style="padding: 12px 10px; font-weight: 900; color: #000000; white-space: nowrap">{{ row.name }}</td>
              <td style="padding: 12px 10px; text-align: center;">
                <span :style="{ ...getStatusBadgeStyle(getLabel('morningMentalStatus', row.morningMentalStatus)), padding: '2px 8px', borderRadius: '4px', fontWeight: '900', border: '1px solid currentColor' }">
                  {{ getLabel('morningMentalStatus', row.morningMentalStatus) || '—' }}
                </span>
                <span :style="{ ...getStatusBadgeStyle(getLabel('lastNightSleep', row.lastNightSleep)), padding: '2px 8px', borderRadius: '4px', fontWidth: 'bold', marginLeft: '4px' }">
                  {{ getLabel('lastNightSleep', row.lastNightSleep) || '—' }}
                </span>
              </td>
              <td style="padding: 12px 10px; text-align: center;">
                <span :style="{ ...getStatusBadgeStyle(getLabel('breakfast', row.breakfast)), padding: '2px 6px', borderRadius: '4px' }">{{ getLabel('breakfast', row.breakfast) || '—' }}</span>
                <span :style="{ ...getStatusBadgeStyle(getLabel('lunch', row.lunch)), padding: '2px 6px', borderRadius: '4px', marginLeft: '4px' }">{{ getLabel('lunch', row.lunch) || '—' }}</span>
                <span :style="{ ...getStatusBadgeStyle(getLabel('dinner', row.dinner)), padding: '2px 6px', borderRadius: '4px', marginLeft: '4px' }">{{ getLabel('dinner', row.dinner) || '—' }}</span>
              </td>
              <td style="padding: 12px 10px; text-align: center;">
                <span :style="{ ...getStatusBadgeStyle(getLabel('excretionStatus', row.excretionStatus)), padding: '2px 8px', borderRadius: '4px' }">{{ getLabel('excretionStatus', row.excretionStatus) || '—' }}</span>
                <span :style="{ ...getStatusBadgeStyle(getLabel('dailyActivity', row.dailyActivity)), padding: '2px 8px', borderRadius: '4px', marginLeft: '4px' }">{{ getLabel('dailyActivity', row.dailyActivity) || '—' }}</span>
              </td>
              <td style="padding: 12px 10px; color: #94a3b8; font-style: italic; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ row.description || '—' }}</td>
              <td style="padding: 12px 10px; text-align: right;" class="no-export">
                <button @click="openEditModal(row)" class="text-blue-600 hover:text-blue-800 font-bold text-xs px-3 py-1 bg-blue-50 rounded border border-blue-200">
                    編輯
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal Overlay -->
    <div v-if="showModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4" style="background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);">
        <div class="w-full max-w-2xl transform rounded-2xl bg-white p-6 shadow-2xl transition-all max-h-[90vh] overflow-y-auto">
            
            <!-- AI Mode -->
            <div v-if="modalMode === 'ai'">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    ✨ AI 紀錄統整
                </h2>
                <div class="mb-4 text-sm text-slate-500 bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <p>系統將自動從 IDEMPIERE 設定 (AD_SysConfig) 讀取 <b>GEMINI_API_KEY</b> 並進行分析。</p>
                </div>
                <div class="mb-6 flex justify-end">
                    <button @click="handleAiGenerate" :disabled="aiGenerating" class="rounded-lg bg-purple-600 px-6 py-2 text-sm font-bold text-white hover:bg-purple-700 disabled:opacity-50">
                        {{ aiGenerating ? '生成中...' : '開始生成' }}
                    </button>
                </div>
                <div v-if="aiResult" class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <h3 class="font-bold text-slate-700 mb-2">生成結果：</h3>
                    <p class="whitespace-pre-wrap text-sm text-slate-600">{{ aiResult }}</p>
                </div>
            </div>

            <!-- Create/Edit Mode -->
            <div v-else>
                <h2 class="text-xl font-bold mb-6 text-slate-800">{{ modalMode === 'create' ? '新增紀錄' : '編輯紀錄' }}</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs font-bold text-slate-500 mb-1">日期</label>
                        <input v-model="form.documentDate" type="date" class="w-full rounded border border-slate-300 px-3 py-2 text-sm">
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs font-bold text-slate-500 mb-1">名稱</label>
                        <input v-model="form.name" type="text" class="w-full rounded border border-slate-300 px-3 py-2 text-sm">
                    </div>
                    
                    <!-- Dynamic Selects -->
                    <div v-for="(val, key) in form" :key="key">
                        <template v-if="!['documentDate', 'name', 'description'].includes(key)">
                            <label class="block text-xs font-bold text-slate-500 mb-1 capitalize">{{ fieldLabels[key] || key }}</label>
                            <select v-model="form[key as keyof typeof form]" class="w-full rounded border border-slate-300 px-3 py-2 text-sm">
                                <option v-for="opt in (options[key as keyof typeof options] || defaultStatusList)" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
                            </select>
                        </template>
                    </div>

                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-slate-500 mb-1">備註 (Memo)</label>
                        <textarea v-model="form.description" rows="3" class="w-full rounded border border-slate-300 px-3 py-2 text-sm"></textarea>
                    </div>
                </div>
                <div class="mt-8 flex justify-end gap-3">
                    <button @click="showModal = false" class="px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700">取消</button>
                    <button @click="handleSave" :disabled="loading" class="rounded-lg bg-blue-600 px-6 py-2 text-sm font-bold text-white shadow hover:bg-blue-700 disabled:opacity-50">
                        {{ loading ? '儲存中...' : '確認儲存' }}
                    </button>
                </div>
            </div>

            <!-- Close Button (Top Right) -->
            <button @click="showModal = false" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>
  </div>
</template>

<style scoped>
@media screen { .print-only { display: none !important; } }
</style>
