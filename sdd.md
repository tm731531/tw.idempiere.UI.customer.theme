# iDempiere Daily Report Plugin - System Design Document (SDD)

## 1. 系統概觀 (System Overview)
本外掛提供一個基於 iDempiere 12 的 JavaScript 視覺化報表，用於展示近七日的營運趨勢（銷貨與採購），並支持按業務夥伴（Business Partner）進行動態數據分類。

## 2. 技術架構 (Technical Architecture)

### 2.1 後端架構 (Backend)
- **DailyReportForm.java**: 
    - 實作 `IFormController` 與 `ADForm`。
    - 負責環境切換（ClassLoader Context Switch），確保 ZK 引擎能找到 OSGi 內的資源。
    - **關鍵點**: 類別名稱必須與 AD 中的 `Classname` 完全一致。
- **DailyReportController.java**: 
    - 採用 ZK 的 `SelectorComposer` 模式。
    - **SQL 邏輯**: 
        - 自動關聯 `C_BPartner`。
        - 強制過濾 `AD_Client_ID` 以保證多租戶安全。
        - 支持動態 Channel（通路/夥伴）分組。
    - **數據橋接**: 使用 `org.zkoss.json` 將 Java Map 轉換為 JS 原生 JSON 對象。

### 2.2 前端架構 (Frontend)
- **DailyReport.zul**:
    - **資源路徑**: 標準存放於 `src/web/` 下，透過 `~./` 引用。
    - **視覺化引擎**: Chart.js 4.4.1 (UMD 格式)。
    - **渲染穩定性**: 使用 `zk.Widget.$('$chartDiv')` 取代 UUID，解決 iDempiere 多視窗環境下的 DOM 識別問題。

## 3. 部署與整合規範 (Standard Integration)

| 項目 | 規範 |
| :--- | :--- |
| **MANIFEST.MF** | 必須包含 `ZK-Resource: /` |
| **AD Form Classname** | 必須填寫 Full Package Name (e.g., `tw.idempiere.customer.forms.DailyReportForm`) |
| **ZUL 引用方式** | 建議放在 `src/web/zul/` 並使用 `~./zul/xxx.zul` |
| **SQL 過濾** | 絕對不可缺少 `AD_Client_ID=?` |

---

## 4. 未來提案：如何給出「一步到位」的訊息？ (One-Go Prompt Template)

為了讓我在下一次任務中能更精準執行，你可以參考以下模板來寫訊息給予：

> **[任務名稱]**：例如「新增庫存週轉率報表」
> 
> **1. 資料來源 (SQL)**：
> - 我要從哪張表拿資料？ (例如 `M_Transaction`)
> - 畫圖的 X 軸是什麼？ (例如 `MovementDate`)
> - 畫圖的 Y 軸或分類是什麼？ (例如 `ProductName`)
> 
> **2. UI 規格**：
> - 想要哪種圖表？ (圓餅圖、長條圖、折線圖)
> - 需要哪些過濾器？ (例如：倉庫、日期範圍)
> 
> **3. 專案慣例 (如有變更)**：
> - ZUL 放在哪裡？ (預設根目錄或 `/zul/`)
> - Form Class 名稱？ (例如 `InventoryReportForm`)
> 
> **4. 範例訊息**：
> 「嘿 Antigravity，幫我做個『倉庫庫存佔比圖』。資料從 `M_StorageOnHand` 抓庫存量，X 軸是庫存數量，分類是 `M_Warehouse`。請用圓餅圖呈現。ZUL 存放在根目錄，Controller 名稱為 `StockReportController`。記得幫我加一個可以選『產品分類』的過濾器。」

---
*Generated by Antigravity - Your iDempiere Expert.*
